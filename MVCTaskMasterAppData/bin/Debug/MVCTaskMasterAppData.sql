/*
Deployment script for MVCTaskMasterAppData

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "MVCTaskMasterAppData"
:setvar DefaultFilePrefix "MVCTaskMasterAppData"
:setvar DefaultDataPath "C:\Users\Angelo\AppData\Local\Microsoft\VisualStudio\SSDT\ASP.NetMVCExample"
:setvar DefaultLogPath "C:\Users\Angelo\AppData\Local\Microsoft\VisualStudio\SSDT\ASP.NetMVCExample"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering [dbo].[SessionsCleaner]...';


GO
--	  Writer: Angelo Sanches (BitSan)(Git:TheTrueTrooper)
--    Date Writen: Sep 14, 2017
--    Project Goal: Make a cloud based app to aid in project management
--    File Goal: To Clean out over due signins and keepa a cleaner table
--    Link: https://github.com/TheTrueTrooper/AngelASPExtentions
--    Sources/References:
--      {
--      Name: NA
--      Writer/Publisher: NA
--      Link: NA
--      }
ALTER TRIGGER [SessionsCleaner]
	ON [dbo].[Sessions]
	FOR insert, delete, update
	AS
	BEGIN
	  delete from [Sessions] where DATEADD(hour, 1, TimeLastValidated) < GETDATE()
	END
GO
PRINT N'Altering [dbo].[CreateTheSession]...';


GO
--	  Writer: Angelo Sanches (BitSan)(Git:TheTrueTrooper)
--    Date Writen: June 23,2017
--    Project Goal: Make a cloud based app to aid in project management
--    File Goal: To sign in on a machine and ensure only on sign in per loction as best as posible
--    Link: https://github.com/TheTrueTrooper/AngelASPExtentions
--    Sources/References:
--      {
--      Name: ASP.net
--      Writer/Publisher: Microsoft
--      Link: https://www.asp.net/
--      }
ALTER PROCEDURE [dbo].[CreateTheSession]
	@UserID int,
	@Code char(28)
AS
	if not exists(select UserID from Users where UserID = @UserID)
		return -1;
	if @Code is null and Len(@Code) < 70
		return -2;
	if exists(select UserID from [Sessions] where UserID = UserID)
	begin
		update [Sessions]
		set Code = @Code,
		TimeLastValidated = GETDATE()
		where UserID = @UserID
	end
	else 
	begin 
	insert into [Sessions] (UserID, Code)
	values (@UserID, @Code)
	end
RETURN 0
GO
PRINT N'Altering [dbo].[DeleteTheSession]...';


GO
--	  Writer: Angelo Sanches (BitSan)(Git:TheTrueTrooper)
--    Date Writen: June 23,2017
--    Project Goal: Make a cloud based app to aid in project management
--    File Goal: To Delete or close a session
--    Link: https://github.com/TheTrueTrooper/AngelASPExtentions
--    Sources/References:
--      {
--      Name: ASP.net
--      Writer/Publisher: Microsoft
--      Link: https://www.asp.net/
--      }
ALTER PROCEDURE [dbo].[DeleteTheSession]
	@SessionID int
AS
	delete from [Sessions] where @SessionID = UserID
RETURN 0
GO
PRINT N'Altering [dbo].[SelectProjectByID]...';


GO
--	  Writer: Angelo Sanches (BitSan)(Git:TheTrueTrooper)
--    Date Writen: Augest 30, 2017
--    Project Goal: Make a cloud based app to aid in project management
--    File Goal: Allow the view of all of the top data of a project
--    Link: https://github.com/TheTrueTrooper/AngelASPExtentions
--    Sources/References:
--      {
--      Name: ASP.net
--      Writer/Publisher: Microsoft
--      Link: https://www.asp.net/
--      }
ALTER PROCEDURE [dbo].[SelectProjectByID]
	@ID int = 0
AS
	SELECT P.ProjectID, P.ProjectName, P.Address as ProjectAddress, P.City as ProjectCity, P.Province as ProjectProvince, P.Country as ProjectCountry, 
	P.PostalCode as ProjectPostalCode, P.StartDate as ProjectStartDate, P.EndDate as ProjectEndDate, 
	P.ActualStartDate as ProjectActualStartDate, P.ActualEndDate as ProjectActualEndDate, P.Description as ProjectDescription, 
	P.CreationDate as ProjectCreationDate,
	U.UserID as ManagerID, U.Picture as ManagerPicture, U.FirstName as ManagerFirstName, U.MiddleInitial as ManagerMiddleInitial, 
	U.LastName as ManagerLastName, U.HomePhone as ManagerHomePhone, U.WorkPhone as ManagerWorkPhone, U.CellPhone as ManagerCellPhone,
	C.CompanyID, C.CompanyName, C.CompanySite
	from Projects as P left join Users as U on P.ManagerID = U.UserID left join Companys as C on P.CompanyID = C.CompanyID 
	where ProjectID = @ID
RETURN 0
GO
PRINT N'Creating [dbo].[SelectProjectByID_Light]...';


GO
CREATE PROCEDURE [dbo].[SelectProjectByID_Light]
	@ID int = 0
AS
	SELECT P.ProjectID, P.ProjectName
	from Projects as P
	where ProjectID = @ID
RETURN 0
GO
PRINT N'Update complete.';


GO
